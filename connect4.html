<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Connect Four - WBE Practical 8-12</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Additional styles */
    .status {
      text-align: center;
      font-size: 1.2rem;
      margin: 15px;
      font-weight: bold;
      min-height: 30px;
    }
    
    .controls {
      text-align: center;
      margin: 20px;
    }
    
    .controls button {
      margin: 5px 10px;
      padding: 10px 20px;
      font-size: 1rem;
      cursor: pointer;
      border: 1px solid #333;
      border-radius: 5px;
      background: #f0f0f0;
      transition: background 0.2s;
    }
    
    .controls button:hover {
      background: #e0e0e0;
    }
    
    .controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .storage-controls {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #ccc;
    }
    
    .red { background-color: #ff4444 !important; }
    .blue { background-color: #4444ff !important; }
    
    .game-info {
      max-width: 800px;
      margin: 20px auto;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    
    .doc-btn {
      background: #6c757d !important;
      color: white !important;
      margin-top: 15px !important;
    }
    
    .doc-btn:hover {
      background: #5a6268 !important;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // GAME STATE - Stores all game data
    
    let gameState = {
      board: Array(6).fill().map(() => Array(7).fill('')),  // 6 rows x 7 columns
      currentPlayer: 'b',  // 'b' = blue, 'r' = red
      gameActive: true,
      winner: null,
      stateHistory: []  // Stores previous states for undo functionality
    }
    
    // SERVER CONFIGURATION - For Practical 10
    
    const SERVER_URL = "http://localhost:3000"
    const DATA_KEY = "connect4-state"
    const API_KEY = "c4game"
    
    // WIN DETECTION - Practical 10 Task 2
    
    // Checks if a player has four in a row
    function checkForWinner(player, board) {
      const rows = 6
      const cols = 7
      
      // Check horizontal lines (left to right)
      for (let row = 0; row < rows; row++) {
        for (let col = 0; col < cols - 3; col++) {
          if (board[row][col] === player &&
              board[row][col + 1] === player &&
              board[row][col + 2] === player &&
              board[row][col + 3] === player) {
            return true
          }
        }
      }
      
      // Check vertical lines (top to bottom)
      for (let row = 0; row < rows - 3; row++) {
        for (let col = 0; col < cols; col++) {
          if (board[row][col] === player &&
              board[row + 1][col] === player &&
              board[row + 2][col] === player &&
              board[row + 3][col] === player) {
            return true
          }
        }
      }
      
      // Check diagonal (top-left to bottom-right)
      for (let row = 0; row < rows - 3; row++) {
        for (let col = 0; col < cols - 3; col++) {
          if (board[row][col] === player &&
              board[row + 1][col + 1] === player &&
              board[row + 2][col + 2] === player &&
              board[row + 3][col + 3] === player) {
            return true
          }
        }
      }
      
      // Check diagonal (top-right to bottom-left)
      for (let row = 0; row < rows - 3; row++) {
        for (let col = 3; col < cols; col++) {
          if (board[row][col] === player &&
              board[row + 1][col - 1] === player &&
              board[row + 2][col - 2] === player &&
              board[row + 3][col - 3] === player) {
            return true
          }
        }
      }
      
      return false
    }
    
    // Checks if board is completely full (draw)
    function isBoardFull(board) {
      for (let row = 0; row < 6; row++) {
        for (let col = 0; col < 7; col++) {
          if (board[row][col] === '') return false
        }
      }
      return true
    }
    
    // GAME LOGIC - Handles moves and game rules
    
    // Makes a move in the specified column
    function makeMove(column) {
      if (!gameState.gameActive) return
      
      // Save current state for undo functionality
      saveStateToHistory()
      
      // Find the lowest empty row in the clicked column
      for (let row = 5; row >= 0; row--) {
        if (gameState.board[row][column] === '') {
          const currentPlayer = gameState.currentPlayer
          
          // Place the piece
          gameState.board[row][column] = currentPlayer
          
          // Check for win
          if (checkForWinner(currentPlayer, gameState.board)) {
            gameState.gameActive = false
            gameState.winner = currentPlayer
            updateGameDisplay()
            alert(`Player ${currentPlayer === 'b' ? 'Blue' : 'Red'} wins!`)
            return
          }
          
          // Check for draw
          if (isBoardFull(gameState.board)) {
            gameState.gameActive = false
            gameState.winner = 'draw'
            updateGameDisplay()
            alert("It's a draw! The board is full.")
            return
          }
          
          // Switch to next player
          gameState.currentPlayer = currentPlayer === 'b' ? 'r' : 'b'
          updateGameDisplay()
          return
        }
      }
      
      // If we get here, the column was full
      alert('This column is already full!')
    }
    
    // Saves current state to history array for undo
    function saveStateToHistory() {
      gameState.stateHistory.push({
        board: gameState.board.map(row => [...row]),  // Deep copy of board
        currentPlayer: gameState.currentPlayer,
        gameActive: gameState.gameActive,
        winner: gameState.winner
      })
    }
    
    // RENDERING FUNCTIONS - Creates game display
    
    // Creates a single game field element
    function createGameField(row, col, value) {
      const field = document.createElement('div')
      field.className = 'field'
      field.dataset.row = row
      field.dataset.col = col
      
      // Add click event - Direct event binding
      field.addEventListener('click', () => {
        console.log(`Clicked column ${col}, row ${row}`)  // Debug log
        makeMove(col)
      })
      
      // Add game piece if field is occupied
      if (value === 'b') {
        const piece = document.createElement('div')
        piece.className = 'piece blue'
        field.appendChild(piece)
      } else if (value === 'r') {
        const piece = document.createElement('div')
        piece.className = 'piece red'
        field.appendChild(piece)
      }
      
      return field
    }
    
    // Creates the complete game board
    function createGameBoard() {
      const boardContainer = document.createElement('div')
      boardContainer.className = 'board'
      
      // Create 6x7 grid of fields
      for (let row = 0; row < 6; row++) {
        for (let col = 0; col < 7; col++) {
          boardContainer.appendChild(
            createGameField(row, col, gameState.board[row][col])
          )
        }
      }
      
      return boardContainer
    }
    
    // Creates status display
    function createStatusDisplay() {
      const status = document.createElement('div')
      status.className = 'status'
      
      let statusText
      if (gameState.winner === 'draw') {
        statusText = "It's a draw!"
      } else if (gameState.winner) {
        const winnerName = gameState.winner === 'b' ? 'Blue' : 'Red'
        statusText = `ðŸŽ‰ Player ${winnerName} wins! ðŸŽ‰`
      } else {
        const playerName = gameState.currentPlayer === 'b' ? 'Blue' : 'Red'
        statusText = `Player ${playerName}'s turn`
      }
      
      status.textContent = statusText
      return status
    }
    
    // Creates control buttons
    function createControls() {
      const controls = document.createElement('div')
      controls.className = 'controls'
      
      controls.innerHTML = `
        <button onclick="startNewGame()">New Game</button>
        <button onclick="undoLastMove()" id="undoBtn" ${gameState.stateHistory.length === 0 ? 'disabled' : ''}>Undo</button>
        <div class="storage-controls">
          <h4>Server Storage</h4>
          <button onclick="saveGameToServer()">Save to Server</button>
          <button onclick="loadGameFromServer()">Load from Server</button>
          <h4 style="margin-top: 15px">Browser Storage</h4>
          <button onclick="saveGameToBrowser()">Save to Browser</button>
          <button onclick="loadGameFromBrowser()">Load from Browser</button>
                <br><br>
          <!-- DOCUMENTATION LINK - ADDED HERE -->
          <button onclick="window.open('documentation.html', '_blank')" 
                  class="doc-btn" style="width: 80%; margin-top: 20px;">
            ðŸ“„ View Project Documentation
          </button>
        </div>
      `
      
      return controls
    }
    
    // Creates game info section
    function createGameInfo() {
      const info = document.createElement('div')
      info.className = 'game-info'
      
      info.innerHTML = `
        <h3>ðŸŽ® How to Play</h3>
        <p>â€¢ Click on a column to drop your piece</p>
        <p>â€¢ Be the first to connect four pieces in a row (horizontal, vertical, or diagonal)</p>
        <p>â€¢ Blue player starts first</p>
        <p>â€¢ Use Undo to take back your last move</p>
        <p>â€¢ Save your game to continue later</p>
      `
      
      return info
    }
    
    // Updates the undo button state
    function updateUndoButton() {
      const undoBtn = document.getElementById('undoBtn')
      if (undoBtn) {
        undoBtn.disabled = gameState.stateHistory.length === 0 || !gameState.gameActive
      }
    }
    
    // Updates the entire game display
    function updateGameDisplay() {
      const app = document.getElementById('app')
      
      // Clear existing content
      app.innerHTML = ''
      
      // Add all game components
      app.appendChild(createStatusDisplay())
      app.appendChild(createGameBoard())
      app.appendChild(createControls())
      app.appendChild(createGameInfo())
      
      // Update undo button state
      updateUndoButton()
    }
    
    // GAME CONTROL FUNCTIONS
    
    // Starts a new game
    function startNewGame() {
      gameState = {
        board: Array(6).fill().map(() => Array(7).fill('')),
        currentPlayer: 'b',
        gameActive: true,
        winner: null,
        stateHistory: []
      }
      updateGameDisplay()
    }
    
    // Undoes the last move
    function undoLastMove() {
      if (gameState.stateHistory.length === 0) return
      
      const previousState = gameState.stateHistory.pop()
      gameState.board = previousState.board
      gameState.currentPlayer = previousState.currentPlayer
      gameState.gameActive = previousState.gameActive
      gameState.winner = previousState.winner
      
      updateGameDisplay()
    }
    
    // SERVER FUNCTIONS - Practical 10
    
    // Saves game state to server
    function saveGameToServer() {
      const url = `${SERVER_URL}/api/data/${DATA_KEY}?api-key=${API_KEY}`
      
      fetch(url, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(gameState)
      })
      .then(response => {
        if (!response.ok) throw new Error('Server error: ' + response.status)
        return response.json()
      })
      .then(() => {
        alert('Game saved to server successfully!')
      })
      .catch(error => {
        console.error('Error saving to server:', error)
        alert('Could not save to server. Check if server is running.')
      })
    }
    
    // Loads game state from server
    function loadGameFromServer() {
      const url = `${SERVER_URL}/api/data/${DATA_KEY}?api-key=${API_KEY}`
      
      fetch(url)
      .then(response => {
        if (!response.ok) throw new Error('Server error: ' + response.status)
        return response.json()
      })
      .then(data => {
        gameState = data
        gameState.stateHistory = gameState.stateHistory || []
        updateGameDisplay()
        alert('Game loaded from server successfully!')
      })
      .catch(error => {
        console.error('Error loading from server:', error)
        alert('Could not load from server. Check if server is running.')
      })
    }
    
    // BROWSER STORAGE FUNCTIONS - Practical 11
    
    // Saves game state to browser's localStorage
    function saveGameToBrowser() {
      try {
        localStorage.setItem('connect4-saved-game', JSON.stringify(gameState))
        alert('Game saved to browser successfully!')
      } catch (error) {
        console.error('Error saving to browser:', error)
        alert('Error saving game to browser storage')
      }
    }
    
    // Loads game state from browser's localStorage
    function loadGameFromBrowser() {
      try {
        const savedData = localStorage.getItem('connect4-saved-game')
        if (savedData) {
          gameState = JSON.parse(savedData)
          gameState.stateHistory = gameState.stateHistory || []
          updateGameDisplay()
          alert('Game loaded from browser successfully!')
        } else {
          alert('No saved game found in browser')
        }
      } catch (error) {
        console.error('Error loading from browser:', error)
        alert('Error loading game from browser storage')
      }
    }
    
    // INITIALIZATION - Runs when page loads
    
    function initializeGame() {
      // Check for saved game in browser
      const savedData = localStorage.getItem('connect4-saved-game')
      if (savedData) {
        if (confirm('A saved game was found. Would you like to load it?')) {
          loadGameFromBrowser()
          return
        }
      }
      
      // Start with a new game
      startNewGame()
    }
    
    // Start the game when page loads
    document.addEventListener('DOMContentLoaded', initializeGame)
    
    // Debug helper - log clicks to console
    console.log('Connect Four game loaded')
    console.log('Click on any column to drop a piece')
  </script>
</body>
</html>